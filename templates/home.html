<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Trax – Banks</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.plaid.com/link/v2/stable/link-initialize.js"></script>
  </head>
  <body class="bg-slate-50 text-slate-900">
    <div class="max-w-4xl mx-auto p-6">
      <header class="flex items-center justify-between mb-6">
        <h1 class="text-2xl font-semibold">Linked banks</h1>
        <button
          id="btn-link-new"
          class="px-4 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700 transition"
        >
          Link new bank
        </button>
      </header>

      <div id="items" class="grid gap-4"></div>

      <template id="item-card">
        <div
          class="bg-white rounded-2xl shadow p-4 flex items-start justify-between"
        >
          <div>
            <div class="text-lg font-medium" data-name>—</div>
            <div class="text-sm text-slate-500 mt-1">
              Item ID: <span data-item-id>—</span>
            </div>
            <div class="text-sm text-slate-500">
              Consent expiry: <span data-expiry>—</span>
            </div>
          </div>
          <div class="flex gap-2">
            <span
              data-badge
              class="px-2 py-1 rounded-lg text-xs font-medium self-start"
            ></span>
            <button
              data-relink
              class="px-3 py-1.5 rounded-xl bg-slate-900 text-white hover:bg-slate-800 text-sm"
            >
              Relink
            </button>
            <button
              data-delete
              class="px-3 py-1.5 rounded-xl bg-red-600 text-white hover:bg-red-700 text-sm"
            >
              Delete
            </button>
          </div>
        </div>
      </template>
    </div>

    <script>
      const $ = (s, r = document) => r.querySelector(s);
      const $$ = (s, r = document) => Array.from(r.querySelectorAll(s));
      const logErr = (e) => console.error(e);

      // ---- Link helpers ----
      async function deleteItem(item_id) {
        if (
          !confirm(
            "Delete this bank link? This revokes access and removes it from this app."
          )
        )
          return;
        const resp = await fetch("/item/remove", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ item_id }),
        });
        if (!resp.ok) {
          const txt = await resp.text();
          alert("Failed to delete: " + txt);
          return;
        }
        await loadItems();
        alert("Deleted.");
      }

      async function ensureLinkToken(opts = {}) {
        const url = opts.update ? "/link_token/update" : "/link_token/create";
        const body = opts.update
          ? JSON.stringify({ item_id: opts.item_id })
          : null;

        const resp = await fetch(url, {
          method: "POST",
          headers: body ? { "Content-Type": "application/json" } : undefined,
          body,
        });
        if (!resp.ok)
          throw new Error(
            "link_token error " + resp.status + " " + (await resp.text())
          );
        const data = await resp.json();
        return data.link_token;
      }

      async function openLinkNew() {
        try {
          const token = await ensureLinkToken();
          const handler = Plaid.create({
            token,
            onSuccess: async (public_token, metadata) => {
              await fetch("/item/public_token/exchange", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  public_token,
                  institution:
                    metadata && metadata.institution
                      ? {
                          institution_id: metadata.institution.id,
                          name: metadata.institution.name,
                        }
                      : null,
                }),
              });
              await loadItems();
              alert("Bank connected.");
            },
            onExit: (err) => {
              if (err) console.warn(err);
            },
          });
          handler.open();
        } catch (e) {
          logErr(e);
          alert(e.message || e);
        }
      }

      async function openLinkUpdate(item_id) {
        try {
          const token = await ensureLinkToken({ update: true, item_id });
          const handler = Plaid.create({
            token,
            onSuccess: async () => {
              await loadItems();
              alert("Relinked.");
            },
            onExit: (err) => {
              if (err) console.warn(err);
            },
          });
          handler.open();
        } catch (e) {
          logErr(e);
          alert(e.message || e);
        }
      }

      // ---- Items rendering ----
      function badge(el, days) {
        el.className = "px-2 py-1 rounded-lg text-xs font-medium self-start";
        if (days == null) {
          el.textContent = "No expiry";
          el.classList.add("bg-slate-100", "text-slate-700");
          return;
        }
        el.textContent =
          days >= 0 ? `${days} days left` : `Expired ${Math.abs(days)}d`;
        if (days > 30) el.classList.add("bg-emerald-100", "text-emerald-800");
        else if (days >= 7) el.classList.add("bg-amber-100", "text-amber-800");
        else if (days >= 0) el.classList.add("bg-red-100", "text-red-800");
        else el.classList.add("bg-red-200", "text-red-900");
      }

      function daysLeft(iso) {
        if (!iso) return null;
        const now = new Date();
        const exp = new Date(iso);
        return Math.floor((exp - now) / (1000 * 60 * 60 * 24));
      }

      async function loadItems() {
        const resp = await fetch("/items");
        const items = await resp.json();
        const wrap = $("#items");
        wrap.innerHTML = "";

        if (!items.length) {
          wrap.innerHTML = `
            <div class="bg-white rounded-2xl p-6 shadow text-slate-600">
              No banks linked yet. Click <b>Link new bank</b> to get started.
            </div>`;
          return;
        }

        for (const it of items) {
          const tpl = $("#item-card").content.cloneNode(true);
          $("[data-relink]", tpl).addEventListener("click", () =>
            openLinkUpdate(it.item_id)
          );
          $("[data-delete]", tpl).addEventListener("click", () =>
            deleteItem(it.item_id)
          );

          $("[data-name]", tpl).textContent =
            it.institution_name || it.institution_id || "Unknown institution";
          $("[data-item-id]", tpl).textContent = it.item_id;
          const expiryText = it.consent_expiration_time
            ? new Date(it.consent_expiration_time).toLocaleString()
            : "—";
          $("[data-expiry]", tpl).textContent = expiryText;

          const d = daysLeft(it.consent_expiration_time);
          badge($("[data-badge]", tpl), d);

          $("[data-relink]", tpl).addEventListener("click", () =>
            openLinkUpdate(it.item_id)
          );
          wrap.appendChild(tpl);
        }
      }

      // init
      $("#btn-link-new").addEventListener("click", openLinkNew);
      loadItems();
    </script>
  </body>
</html>
